#!/usr/bin/env python

####
## This code is adapted and modified by-
## fireball003@gmail.com
## Date: December 23, 2015
####

import csv
import sys


# Name of file
finput = sys.argv[1]

# The items to get
items = ['CVSS', 'Host','Protocol', 'Port', 'Name']
itemindex = []
finalList = []

# Get the lines in the file
def map_function(line):
    # Extract only needed items
    tmp = [line[i].rstrip() for i in itemindex]
    return tmp

# Open the file
with open(finput, 'r') as csvfile:
    # Get file iterator
    rows = csv.reader(csvfile)
    
    # Get the title
    title = rows.next()
    print title
    itemindex = []
    for i in items:
        if i in title:
            itemindex.append(title.index(i))
        else:
            print i, "is not a column!"
    
    print "ITEM INDEX"
    print itemindex
    # Get input statistics
    map_result = map(map_function, rows)

    finalList = map_result



# Data goes from list to dictionary where keys are $NAME+   $CVSS 
# And values are $HOST:$PORT   $PROTOCOL

data={}
for i in finalList:
    #print i
    name = str(i[4])+'    '+str(i[0])
    #print 'name:\t'+ name
    value = str(i[1])+':'+str(i[3])+"\t("+str(i[2])+')'
    if data.has_key(name):
        data[name].append(value)

    else:
        data[name] = [value]

# The data is printed and saved in files

foutput = "output.txt"

with open(foutput, "w") as output:
    for d in data:
        print "\n\n"+ d +"\n\n"
        output.write("\n\n"+ d +"\n\n")
        filtered = sorted(set(data[d]))
        for i in filtered:
            print i
            output.write(i+"\n")
